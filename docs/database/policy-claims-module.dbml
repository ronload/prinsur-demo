Project policy_claims_module {
    database_type: 'PostgreSQL'
    Note: '''
    保單與理賠管理模組
    包含：保單投保、繳費管理、理賠申請、系統通知
    '''
}

//// ==========================================
//// 保單與理賠管理模組 (Policy & Claims)
//// ==========================================

// 引用其他模組的主表（僅顯示關聯）
Table customer_profiles [headercolor: #E8E8E8] {
    user_id int [pk]
    Note: '來自 profiles-module'
}

Table agent_profiles [headercolor: #E8E8E8] {
    user_id int [pk]
    Note: '來自 profiles-module'
}

Table insurances [headercolor: #E8E8E8] {
    id   int     [pk]
    name varchar
    Note: '來自 insurance-module'
}

Table users [headercolor: #E8E8E8] {
    id int [pk]
    Note: '來自 user-auth-module'
}

//// 🔹 保單投保主表
Table policy_enrollments [headercolor: #127859] {
    id            int         [pk, increment, note: 'GENERATED ALWAYS AS IDENTITY']
    customer_id   int         [not null]
    agent_id      int         [not null]
    insurance_id  int         [not null]
    policy_number text        [not null, unique, note: '保單號碼']
    created_at    timestamptz [default: `now()`]
    created_by    int         [not null]
    updated_at    timestamptz [default: `now()`]
    updated_by    int         [not null]
    deleted_at    timestamptz
    deleted_by    int

    Indexes {
        customer_id
        agent_id
        insurance_id
    }

    Note: '保單投保記錄（三方關係：客戶、業務員、保險商品）'
}
Ref: policy_enrollments.customer_id > customer_profiles.user_id [delete: restrict]
Ref: policy_enrollments.agent_id > agent_profiles.user_id [delete: restrict]
Ref: policy_enrollments.insurance_id > insurances.id [delete: restrict]

//// 🔹 保單繳費詳情
Enum payment_frequency {
    monthly
    annually
    other
}

Table policy_enrollments_details [headercolor: #127859] {
    id                   int               [pk, increment, note: 'GENERATED ALWAYS AS IDENTITY']
    policy_enrollment_id int               [not null]
    transaction_date     timestamptz       [not null, note: '交易日期']
    insured_amount       numeric(12, 2)    [not null, note: '保障金額']
    start_date           timestamptz       [note: '保單生效日']
    end_date             timestamptz       [note: '保單到期日']
    payment_frequency    payment_frequency [not null]
    payment_amount       numeric(12, 2)    [not null, note: '繳費金額']
    next_due_date        timestamptz       [not null, note: '下次繳費日']
    is_active            boolean           [not null, note: '是否有效']

    Indexes {
        policy_enrollment_id
    }

    Note: '保單繳費詳情與狀態管理'
}
Ref: policy_enrollments_details.policy_enrollment_id - policy_enrollments.id

//// 🔹 理賠申請
Enum claim_status {
    pending
    approved
    rejected
    processing
}

Table claims [headercolor: #127859] {
    id                   int            [pk, increment, note: 'GENERATED ALWAYS AS IDENTITY']
    policy_enrollment_id int            [not null]
    status               claim_status
    message              text           [note: '理賠說明/拒賠原因']
    amount               numeric(12, 2) [note: '理賠金額']
    submit_date          timestamptz
    created_at           timestamptz    [default: `now()`]
    created_by           int            [not null]
    updated_at           timestamptz    [default: `now()`]
    updated_by           int            [not null]
    deleted_at           timestamptz
    deleted_by           int

    Note: '理賠申請與處理狀態'
}
Ref: claims.policy_enrollment_id - policy_enrollments.id

//// 🔹 理賠附件（診斷證明、收據等）
Table claim_attachments [headercolor: #127859] {
    id          int         [pk, increment]
    claim_id    int         [not null]
    file_url    text        [not null, note: '檔案儲存路徑/URL']
    file_name   varchar(255)
    uploaded_at timestamptz [default: `now()`]
    uploaded_by int         [not null]

    Note: '理賠申請附件（診斷證明、醫療收據等）'
}
Ref: claim_attachments.claim_id > claims.id

//// 🔹 系統通知（包含繳費提醒）
Table notifications [headercolor: #A23456] {
    id         int         [pk, increment, note: 'GENERATED ALWAYS AS IDENTITY']
    user_id    int         [not null]
    title      text        [not null]
    payload    jsonb       [not null, note: 'JSON 格式，包含通知詳情']
    action_url text        [note: '點擊後跳轉的 URL']
    sent_at    timestamptz [not null, default: `now()`]
    read_at    timestamptz

    Indexes {
        (user_id, read_at)
    }

    Note: '''
    系統通知中心
    payload 範例：
    {
      "type": "payment_reminder",
      "policy_name": "終身壽險",
      "due_date": "2025-11-15",
      "amount": 12000
    }
    '''
}
Ref: notifications.user_id > users.id
