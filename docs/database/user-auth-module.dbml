Project user_auth_module {
    database_type: 'PostgreSQL'
    Note: '''
    ç”¨æˆ¶èªè­‰èˆ‡æˆæ¬Šæ¨¡çµ„
    åŒ…å«ï¼šç”¨æˆ¶ç®¡ç†ã€å¯†ç¢¼å®‰å…¨ã€Sessionç®¡ç†ã€å¯©è¨ˆè¿½è¹¤
    '''
}

//// ==========================================
//// ç”¨æˆ¶èªè­‰èˆ‡æˆæ¬Šæ¨¡çµ„ (User Authentication)
//// ==========================================

Enum user_role {
    admin
    manager
    staff
    user
}

// ğŸ”¹ ç”¨æˆ¶ä¸»è¡¨
Table users [headercolor: #3498db] {
    id         int         [pk, increment, note: 'GENERATED ALWAYS AS IDENTITY']
    email      text        [not null, unique]
    name       text        [not null]
    role       user_role   [not null, default: `user`]
    created_at timestamptz [not null, default: `now()`]
    updated_at timestamptz [not null, default: `now()`]
    deleted_at timestamptz
    deleted_by int

    Note: 'ç³»çµ±ç”¨æˆ¶ä¸»è¡¨ï¼Œå„²å­˜åŸºæœ¬èº«ä»½è³‡è¨Š'
}

// ğŸ”¹ å¯†ç¢¼æ†‘è­‰ï¼ˆArgon2id åŠ å¯†ï¼‰
Table user_credentials [headercolor: #3498db] {
    user_id              int          [pk]
    password_hash        varchar(255) [not null, note: 'Argon2id hash']
    password_algo        text         [not null, default: `argon2id`]
    password_attempts    int          [default: 0, note: 'ç™»å…¥å¤±æ•—æ¬¡æ•¸']
    locked_until         timestamptz  [note: 'å¸³è™Ÿé–å®šæ™‚é–“']
    last_password_change timestamptz

    Indexes {
        locked_until
    }

    Note: 'å¯†ç¢¼æ†‘è­‰è¡¨ï¼Œä½¿ç”¨ Argon2id å–®å‘åŠ å¯†'
}
Ref: user_credentials.user_id - users.id [delete: cascade]

// ğŸ”¹ åŠ å¯†æ•æ„Ÿè³‡æ–™ï¼ˆAES-256-GCMï¼‰
Table user_encrypted_data {
    user_id         int         [pk]
    phone_encrypted bytea       [note: 'AES-256-GCM encrypted phone number']
    phone_iv        bytea       [note: 'Initialization Vector (16 bytes)']
    phone_auth_tag  bytea       [note: 'Authentication Tag (16 bytes)']
    phone_key_id    varchar(50) [note: 'Encryption key version ID']
    phone_hash      varchar(64) [unique, note: 'HMAC-SHA256 for search/lookup']

    Note: 'æ•æ„Ÿè³‡æ–™åŠ å¯†å„²å­˜ï¼Œæ”¯æ´é‡‘é‘°ç‰ˆæœ¬ç®¡ç†'
}
Ref: user_encrypted_data.user_id > users.id [delete: cascade]

// ğŸ”¹ ç¬¬ä¸‰æ–¹èº«ä»½æä¾›è€…
Enum identity_provider {
    google
    facebook
}

Table user_identities [headercolor: #3498db] {
    user_id           int               [not null]
    provider          identity_provider [not null]
    provider_user_id  text              [not null]
    email_verified_at timestamptz
    created_at        timestamptz       [default: `now()`]

    Indexes {
        (provider, provider_user_id) [unique]
    }

    Note: 'OAuth ç¬¬ä¸‰æ–¹ç™»å…¥ç¶å®š'
}
Ref: user_identities.user_id > users.id [delete: cascade]

// ğŸ”¹ ç”¨æˆ¶ Session ç®¡ç†ï¼ˆSHA-256 Tokenï¼‰
Table user_sessions [headercolor: #3498db] {
    id                 int         [pk, increment, note: 'GENERATED ALWAYS AS IDENTITY']
    user_id            int         [not null]
    session_token_hash varchar(64) [not null, unique, note: 'SHA256 hash of session token']
    expires_at         timestamptz [not null]
    ip_address         inet
    user_agent         text
    is_active          boolean     [default: true]
    created_at         timestamptz [default: `now()`]
    last_seen_at       timestamptz [default: `now()`]
    terminated_at      timestamptz

    Indexes {
        expires_at
        (user_id, is_active)
    }

    Note: 'Session ç®¡ç†ï¼Œæ”¯æ´å¤šè£ç½®ç™»å…¥èˆ‡å¼·åˆ¶ç™»å‡º'
}
Ref: user_sessions.user_id > users.id [delete: cascade]

// ğŸ”¹ ç”¨æˆ¶åå¥½è¨­å®š
Enum user_theme {
    system
    light
    dark
}

Enum user_locale {
    en
    zh_TW
}

Table user_preferences [headercolor: #3498db] {
    user_id    int         [pk]
    theme      user_theme
    locale     user_locale
    created_at timestamptz [default: `now()`]
    created_by int         [not null]
    updated_at timestamptz [default: `now()`]
    updated_by int         [not null]

    Note: 'ç”¨æˆ¶ä»‹é¢åå¥½è¨­å®šï¼ˆä¸»é¡Œã€èªè¨€ï¼‰'
}
Ref: user_preferences.user_id - users.id [delete: cascade]

// ğŸ”¹ å¯©è¨ˆè¿½è¹¤ï¼ˆAudit Trailï¼‰
Enum action {
    SELECT
    INSERT
    UPDATE
    DELETE
}

Enum action_result {
    success
    failure
    partial
}

Table audit_logs [headercolor: #3498db] {
    id         bigint        [pk, increment, note: 'GENERATED ALWAYS AS IDENTITY']
    table_name varchar       [not null]
    record_id  int           [not null]
    action     action        [not null]
    result     action_result [not null]
    old_values jsonb
    new_values jsonb
    user_id    int
    ip_address inet
    created_at timestamptz   [default: `now()`]

    Indexes {
        (table_name, record_id)
        created_at
    }

    Note: 'ç³»çµ±å¯©è¨ˆæ—¥èªŒï¼Œè¨˜éŒ„æ‰€æœ‰è³‡æ–™è®Šæ›´'
}
Ref: audit_logs.user_id > users.id [delete: restrict]
