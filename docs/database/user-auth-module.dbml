Project user_auth_module {
    database_type: 'PostgreSQL'
    Note: '''
    用戶認證與授權模組
    包含：用戶管理、密碼安全、Session管理、審計追蹤
    '''
}

//// ==========================================
//// 用戶認證與授權模組 (User Authentication)
//// ==========================================

Enum user_role {
    admin
    manager
    staff
    user
}

// 🔹 用戶主表
Table users [headercolor: #3498db] {
    id         int         [pk, increment, note: 'GENERATED ALWAYS AS IDENTITY']
    email      text        [not null, unique]
    name       text        [not null]
    role       user_role   [not null, default: `user`]
    created_at timestamptz [not null, default: `now()`]
    updated_at timestamptz [not null, default: `now()`]
    deleted_at timestamptz
    deleted_by int

    Note: '系統用戶主表，儲存基本身份資訊'
}

// 🔹 密碼憑證（Argon2id 加密）
Table user_credentials [headercolor: #3498db] {
    user_id              int          [pk]
    password_hash        varchar(255) [not null, note: 'Argon2id hash']
    password_algo        text         [not null, default: `argon2id`]
    password_attempts    int          [default: 0, note: '登入失敗次數']
    locked_until         timestamptz  [note: '帳號鎖定時間']
    last_password_change timestamptz

    Indexes {
        locked_until
    }

    Note: '密碼憑證表，使用 Argon2id 單向加密'
}
Ref: user_credentials.user_id - users.id [delete: cascade]

// 🔹 加密敏感資料（AES-256-GCM）
Table user_encrypted_data {
    user_id         int         [pk]
    phone_encrypted bytea       [note: 'AES-256-GCM encrypted phone number']
    phone_iv        bytea       [note: 'Initialization Vector (16 bytes)']
    phone_auth_tag  bytea       [note: 'Authentication Tag (16 bytes)']
    phone_key_id    varchar(50) [note: 'Encryption key version ID']
    phone_hash      varchar(64) [unique, note: 'HMAC-SHA256 for search/lookup']

    Note: '敏感資料加密儲存，支援金鑰版本管理'
}
Ref: user_encrypted_data.user_id > users.id [delete: cascade]

// 🔹 第三方身份提供者
Enum identity_provider {
    google
    facebook
}

Table user_identities [headercolor: #3498db] {
    user_id           int               [not null]
    provider          identity_provider [not null]
    provider_user_id  text              [not null]
    email_verified_at timestamptz
    created_at        timestamptz       [default: `now()`]

    Indexes {
        (provider, provider_user_id) [unique]
    }

    Note: 'OAuth 第三方登入綁定'
}
Ref: user_identities.user_id > users.id [delete: cascade]

// 🔹 用戶 Session 管理（SHA-256 Token）
Table user_sessions [headercolor: #3498db] {
    id                 int         [pk, increment, note: 'GENERATED ALWAYS AS IDENTITY']
    user_id            int         [not null]
    session_token_hash varchar(64) [not null, unique, note: 'SHA256 hash of session token']
    expires_at         timestamptz [not null]
    ip_address         inet
    user_agent         text
    is_active          boolean     [default: true]
    created_at         timestamptz [default: `now()`]
    last_seen_at       timestamptz [default: `now()`]
    terminated_at      timestamptz

    Indexes {
        expires_at
        (user_id, is_active)
    }

    Note: 'Session 管理，支援多裝置登入與強制登出'
}
Ref: user_sessions.user_id > users.id [delete: cascade]

// 🔹 用戶偏好設定
Enum user_theme {
    system
    light
    dark
}

Enum user_locale {
    en
    zh_TW
}

Table user_preferences [headercolor: #3498db] {
    user_id    int         [pk]
    theme      user_theme
    locale     user_locale
    created_at timestamptz [default: `now()`]
    created_by int         [not null]
    updated_at timestamptz [default: `now()`]
    updated_by int         [not null]

    Note: '用戶介面偏好設定（主題、語言）'
}
Ref: user_preferences.user_id - users.id [delete: cascade]

// 🔹 審計追蹤（Audit Trail）
Enum action {
    SELECT
    INSERT
    UPDATE
    DELETE
}

Enum action_result {
    success
    failure
    partial
}

Table audit_logs [headercolor: #3498db] {
    id         bigint        [pk, increment, note: 'GENERATED ALWAYS AS IDENTITY']
    table_name varchar       [not null]
    record_id  int           [not null]
    action     action        [not null]
    result     action_result [not null]
    old_values jsonb
    new_values jsonb
    user_id    int
    ip_address inet
    created_at timestamptz   [default: `now()`]

    Indexes {
        (table_name, record_id)
        created_at
    }

    Note: '系統審計日誌，記錄所有資料變更'
}
Ref: audit_logs.user_id > users.id [delete: restrict]
